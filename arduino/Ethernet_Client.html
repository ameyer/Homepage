<!DOCTYPE html >

<html lang="en">
<head>
<meta charset="utf-8"/>
<link href="style/main.css" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.0/mootools-yui-compressed.js" type="text/javascript"></script>
<script type="text/javascript">
	
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	
	ga('create', 'UA-4050921-11', 'auto');
	ga('send', 'pageview');
	
	function nospam(user,domain) { window.location = "mailto:" + user + "@" + domain; }
		
		
	window.addEvent('domready', function(){

		$$('.codeHead .copy').addEvent('click', function(event) {
			this.highlight();
			event.stop();
			
			var code = this.getParent('.codesnip-container').getElement('.codesnip');
			
			if (code.select) {
				code.select();
			}else if (document.selection) {
				var range = document.body.createTextRange();
				range.moveToElementText(code);
				range.select();
			} else if (window.getSelection) {
				var range = document.createRange();
				range.selectNode(code);
				window.getSelection().addRange(range);
			}
			
			
			try {
				var successful = document.execCommand('copy');
				var msg = successful ? 'successful' : 'unsuccessful';
				console.log('Copying text command was ' + msg);
			} catch (err) {
				console.log('Oops, unable to copy');
			}
		});
	
	});
	</script>
<!--
	
	Icon Set:	IcoMoon - Free -- http://keyamoon.com/icomoon/
	License:	CC BY-SA 3.0 -- http://creativecommons.org/licenses/by-sa/3.0/
	
	
	Icon Set:	Broccolidry -- http://dribbble.com/shots/587469-Free-16px-Broccolidryiconsaniconsetitisfullof-icons
	License:	Aribitrary -- http://licence.visualidiot.com/
	
	-->
<title>Adam meyer | Arduino</title>
</head>
<body>
<div id="headerWrapper">
<div id="header">
<h1><a href="http://adam-meyer.com">Adam meyer</a></h1>
<h2>Design + Code</h2>
<div id="topNav">
<a href="../about.html" id="aboutLink">About</a>
<a href="../resume.pdf">Resume</a>
<a href="../index.html">Portfolio</a>
<a href="index.html">Arduino Articles</a>
<span id="contactLink"><span onclick="javascript:nospam('sternmeyer','gmail.com');">Contact</span>
<div id="contactLinks">
<a class="icon-twitter" href="http://twitter.com/sternmeyer" title="twitter"></a>
<a class="icon-linkedin" href="http://www.linkedin.com/pub/adam-meyer/20/7a/850/" title="linked in"></a>
<a class="icon-dribbble" href="http://dribbble.com/ameyer" title="dribbble"></a>
<a class="icon-github" href="https://github.com/ameyer" title="github"></a>
<a class="icon-instagram" href="http://instagram.com/sternmeyer" title="instagram"></a>
<a class="icon-envelope2" href="mailto:sternmeyer@gmail.com" title="email"></a>
</div>
</span>
</div>
</div>
</div>
<div id="articleWrapper">
<div class="content">
<div class="post"><h2>Getting Data From The Web - Arduino + Ethernet</h2>
<div class="postContent">
<p><img class="noFrame" src="images/2011/06/ethernet_shield_client.jpg"/></p>
<div class="columnBody">
<div class="leftColumn">
         Yesterday we covered how you would go about <a href="./arduino-ethernet-pin-control">controlling pins of your arduino over the internet</a> using the Arduino Ethernet Shield set up as a server. Today we are going to take a look at using the shield as a client to get information off of a web page, and report back. I used this method a few months ago when I made the <a href="./twixie">Nixie Twitter follower counter dubbed Twixie</a>.
<p>The ethernet shield can be used to access any non-password protected site with ease, but getting the information back to you is the hard part. For Twixie I created a special php page that queried the twitter API and displayed only the twitter count. This made it so I didn't have to tell the arduino what to look for, or scour endless lines of HTML looking for a single number. For our example im going simplier. I created a PHP file that just outputs a random alphanumeric string. I did this because getting everyone setup with an API account somewhere is beyond the scope of this article, and unneeded to prove the concept and get you started. But, the idea is that you could easily take that PHP file (any web accessible file) and taylor it to display whatever you need.</p>
<p>
            In the client mode, the ethernet shield is able to access a webpage and return what is read. But the reading is done one byte at a time, and it reads the entire thing. So it can be like a needle in a haystack on large pages. Even if the page we are reading contains only the information we need, there is extra information at the beginning that is sent to the arduino. You never see it, but a web server actually sends extra information  know as a "header" that tells the browser various information about that page (this is different than HTML's 
            <head>
               tag). 
         </head></p>
<p> Because of this, we need a way to tell the arduino what is junk, and what is the good stuff. To do this we are going to surround the information in &lt; &gt;. When the Arduino starts to read the page we tell it to ignore everything until it sees "&lt;". From this point on we tell the arduino to record each following character until it sees our ending character "&gt;". At this point the arduino has everything it needs, and disconnects from the server then reports back with the data it found.</p>
<p>The Ethernet Shield library does not come with DNS support out of the box meaning we can not simply access the website we need by its simple URL (like http://arduino.cc). No, sadly, we need to have access the site through an IP address. For instance, bildr's IP address is 174.123.231.247 and you can actually access bildr like so http://174.123.231.247/~bildr/ - Not every web-server allows you to do this, but when you can it is typically IPADDRESS/~ACCOUNT_USERNAME - So you can see the PHP file I created for you here http://174.123.231.247/~bildr/examples/ethernet/</p>
</div>
<div class="rightColumn">
<p><a href="images/2011/06/arduino-ethernet-client.png"><img alt="" class="alignleft size-full wp-image-1331" height="727" src="images/2011/06/arduino-ethernet-client.png" title="arduino-ethernet-client" width="363"/></a></p>
</div>
</div>
<h3>Code</h3>
<p><del>Without an extra library, the ethernet code does not support DHCP and therefore requires that we hardcode the IP Address, gateway address, and subnet mask for your network. This isn't really that hard, it is more of a pain when especially if you want to plug it into a different network as the same settings may not work.</del></p>
<p><del>If you are familiar with your network and how to do this, awesome, just make sure you change the setting at the top of the code to fit your network. If you are not familiar with it, we can help you in the forum, and have posted some general help in there as well.</del></p>
<p>As of Arduino 1.0, DHCP is supported, so this should be able to just plug into most networks and start working.</p>
<p>NOW 1.0 COMPATIBLE</p>
<div class="codesnip-container">
<div class="codeHead">
<a class="copy" href="#">Copy Code</a>
</div>
<pre class="arduino codesnip" style="font-family:monospace;">
<span class="co2">#include &lt;Ethernet.h&gt;</span>
<span class="co2">#include &lt;SPI.h&gt;</span>

<span class="co1">////////////////////////////////////////////////////////////////////////</span>
<span class="co1">//CONFIGURE</span>
<span class="co1">////////////////////////////////////////////////////////////////////////</span>
<span class="kw4">byte</span> server<span class="br0">[</span><span class="br0">]</span> <span class="sy0">=</span> <span class="br0">{</span> 174<span class="sy0">,</span>123<span class="sy0">,</span>231<span class="sy0">,</span>247 <span class="br0">}</span><span class="sy0">;</span> <span class="co1">//ip Address of the server you will connect to</span>

<span class="co1">//The location to go to on the server</span>
<span class="co1">//make sure to keep HTTP/1.0 at the end, this is telling it what type of file it is</span>
String location <span class="sy0">=</span> <span class="st0">"/~bildr/examples/ethernet/ HTTP/1.0"</span><span class="sy0">;</span>


<span class="co1">// if need to change the MAC address (Very Rare)</span>
<span class="kw4">byte</span> mac<span class="br0">[</span><span class="br0">]</span> <span class="sy0">=</span> <span class="br0">{</span> 0xDE<span class="sy0">,</span> 0xAD<span class="sy0">,</span> 0xBE<span class="sy0">,</span> 0xEF<span class="sy0">,</span> 0xFE<span class="sy0">,</span> 0xED <span class="br0">}</span><span class="sy0">;</span>
<span class="co1">////////////////////////////////////////////////////////////////////////</span>

EthernetClient client<span class="sy0">;</span>

<span class="kw4">char</span> inString<span class="br0">[</span>32<span class="br0">]</span><span class="sy0">;</span> <span class="co1">// string for incoming serial data</span>
<span class="kw4">int</span> stringPos <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> <span class="co1">// string index counter</span>
<span class="kw4">boolean</span> startRead <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span> <span class="co1">// is reading?</span>

<span class="kw4">void</span> setup<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  Ethernet.<span class="me1">begin</span><span class="br0">(</span>mac<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw3">Serial</span>.<span class="me1">begin</span><span class="br0">(</span>9600<span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>

<span class="kw4">void</span> loop<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  String pageValue <span class="sy0">=</span> connectAndRead<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//connect to the server and read the output</span>

  <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span>pageValue<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//print out the findings.</span>

  <span class="kw3">delay</span><span class="br0">(</span>5000<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//wait 5 seconds before connecting again</span>
<span class="br0">}</span>

String connectAndRead<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="co1">//connect to the server</span>

  <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span><span class="st0">"connecting..."</span><span class="br0">)</span><span class="sy0">;</span>

  <span class="co1">//port 80 is typical of a www page</span>
  <span class="kw1">if</span> <span class="br0">(</span>client.<span class="me1">connect</span><span class="br0">(</span>server<span class="sy0">,</span> 80<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
    <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span><span class="st0">"connected"</span><span class="br0">)</span><span class="sy0">;</span>
    client.<span class="me1">print</span><span class="br0">(</span><span class="st0">"GET "</span><span class="br0">)</span><span class="sy0">;</span>
    client.<span class="me1">println</span><span class="br0">(</span>location<span class="br0">)</span><span class="sy0">;</span>
    client.<span class="me1">println</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>

    <span class="co1">//Connected - Read the page</span>
    <span class="kw1">return</span> readPage<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//go and read the output</span>

  <span class="br0">}</span><span class="kw1">else</span><span class="br0">{</span>
    <span class="kw1">return</span> <span class="st0">"connection failed"</span><span class="sy0">;</span>
  <span class="br0">}</span>

<span class="br0">}</span>

String readPage<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="co1">//read the page, and capture &amp; return everything between '&lt;' and '&gt;'</span>

  stringPos <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
  memset<span class="br0">(</span> <span class="sy0">&amp;</span>inString<span class="sy0">,</span> 0<span class="sy0">,</span> 32 <span class="br0">)</span><span class="sy0">;</span> <span class="co1">//clear inString memory</span>

  <span class="kw1">while</span><span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="br0">{</span>

    <span class="kw1">if</span> <span class="br0">(</span>client.<span class="me1">available</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
      <span class="kw4">char</span> c <span class="sy0">=</span> client.<span class="me1">read</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>

      <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'&lt;'</span> <span class="br0">)</span> <span class="br0">{</span> <span class="co1">//'&lt;' is our begining character</span>
        startRead <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span> <span class="co1">//Ready to start reading the part </span>
      <span class="br0">}</span><span class="kw1">else</span> <span class="kw1">if</span><span class="br0">(</span>startRead<span class="br0">)</span><span class="br0">{</span>

        <span class="kw1">if</span><span class="br0">(</span>c <span class="sy0">!=</span> <span class="st0">'&gt;'</span><span class="br0">)</span><span class="br0">{</span> <span class="co1">//'&gt;' is our ending character</span>
          inString<span class="br0">[</span>stringPos<span class="br0">]</span> <span class="sy0">=</span> c<span class="sy0">;</span>
          stringPos <span class="sy0">++;</span>
        <span class="br0">}</span><span class="kw1">else</span><span class="br0">{</span>
          <span class="co1">//got what we need here! We can disconnect now</span>
          startRead <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
          client.<span class="me1">stop</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
          client.<span class="me1">flush</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
          <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span><span class="st0">"disconnecting."</span><span class="br0">)</span><span class="sy0">;</span>
          <span class="kw1">return</span> inString<span class="sy0">;</span>

        <span class="br0">}</span>

      <span class="br0">}</span>
    <span class="br0">}</span>

  <span class="br0">}</span>

<span class="br0">}</span></pre>
<div class="codeFoot">
   Unless otherwise stated, this code is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> - Please use, change and share it.
   </div>
</div>
<p>The example php file. This just creates a random alpha-numberic string like &lt;1Hc2f&gt;</p>
<div class="codesnip-container">
<div class="codeHead">
<a class="copy" href="#">Copy Code</a>
</div>
<pre class="php codesnip" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
   <span class="co1">//the arduino will store anything between '&lt;' and '&gt;'</span>
   <span class="co1">//So if the output was &lt;1kjhghk5&gt; - the  arduino would read 1kjhghk5</span>
   <span class="co1">//Just generates a random alphanumeric string</span>
   <span class="re0">$what_the_arduino_reads</span> <span class="sy0">=</span> <span class="st_h">'1'</span><span class="sy0">.</span><a href="http://www.php.net/base_convert"><span class="kw3">base_convert</span></a><span class="br0">(</span><a href="http://www.php.net/rand"><span class="kw3">rand</span></a><span class="br0">(</span>10000<span class="sy0">,</span>9999999<span class="br0">)</span><span class="sy0">,</span> 10<span class="sy0">,</span> 36<span class="br0">)</span><span class="sy0">;</span>
   <span class="kw1">echo</span> <span class="st_h">'&lt;'</span><span class="sy0">.</span><span class="re0">$what_the_arduino_reads</span><span class="sy0">.</span><span class="st_h">'&gt;'</span><span class="sy0">;</span>
<span class="sy1">?&gt;</span></pre>
<div class="codeFoot">
   Unless otherwise stated, this code is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> - Please use, change and share it.
   </div>
</div>
</div>
<div id="attribution">
<p>Article taken from <a href="http://bildr.org/arduino-ethernet-client">bildr.org</a> with minor changes - <i>I am the original author of this content</i></p>
<div id="attributionIcons">
<div class="ccIcon cc"></div>
<div class="ccIcon sa"></div>
<div class="ccIcon attribution"></div>
<div id="attributionText">
<a href="https://creativecommons.org/licenses/by-sa/3.0/">Content available under:<br/>Attribution-Share Alike 3.0 Unported</a>
</div>
</div>
</div>
</div></div></div></body></html>
<!DOCTYPE html >

<html lang="en">
<head>
<meta charset="utf-8"/>
<link href="style/main.css" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.0/mootools-yui-compressed.js" type="text/javascript"></script>
<script type="text/javascript">
	
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	
	ga('create', 'UA-4050921-11', 'auto');
	ga('send', 'pageview');
	
	function nospam(user,domain) { window.location = "mailto:" + user + "@" + domain; }
		
		
	window.addEvent('domready', function(){

		$$('.codeHead .copy').addEvent('click', function(event) {
			this.highlight();
			event.stop();
			
			var code = this.getParent('.codesnip-container').getElement('.codesnip');
			
			if (code.select) {
				code.select();
			}else if (document.selection) {
				var range = document.body.createTextRange();
				range.moveToElementText(code);
				range.select();
			} else if (window.getSelection) {
				var range = document.createRange();
				range.selectNode(code);
				window.getSelection().addRange(range);
			}
			
			
			try {
				var successful = document.execCommand('copy');
				var msg = successful ? 'successful' : 'unsuccessful';
				console.log('Copying text command was ' + msg);
			} catch (err) {
				console.log('Oops, unable to copy');
			}
		});
	
	});
	</script>
<!--
	
	Icon Set:	IcoMoon - Free -- http://keyamoon.com/icomoon/
	License:	CC BY-SA 3.0 -- http://creativecommons.org/licenses/by-sa/3.0/
	
	
	Icon Set:	Broccolidry -- http://dribbble.com/shots/587469-Free-16px-Broccolidryiconsaniconsetitisfullof-icons
	License:	Aribitrary -- http://licence.visualidiot.com/
	
	-->
<title>Adam meyer | Arduino</title>
</head>
<body>
<div id="headerWrapper">
<div id="header">
<h1><a href="http://adam-meyer.com">Adam meyer</a></h1>
<h2>Design + Code</h2>
<div id="topNav">
<a href="../about.html" id="aboutLink">About</a>
<a href="../resume.pdf">Resume</a>
<a href="../index.html">Portfolio</a>
<a href="index.html">Arduino Articles</a>
<span id="contactLink"><span onclick="javascript:nospam('sternmeyer','gmail.com');">Contact</span>
<div id="contactLinks">
<a class="icon-twitter" href="http://twitter.com/sternmeyer" title="twitter"></a>
<a class="icon-linkedin" href="http://www.linkedin.com/pub/adam-meyer/20/7a/850/" title="linked in"></a>
<a class="icon-dribbble" href="http://dribbble.com/ameyer" title="dribbble"></a>
<a class="icon-github" href="https://github.com/ameyer" title="github"></a>
<a class="icon-instagram" href="http://instagram.com/sternmeyer" title="instagram"></a>
<a class="icon-envelope2" href="mailto:sternmeyer@gmail.com" title="email"></a>
</div>
</span>
</div>
</div>
</div>
<div id="articleWrapper">
<div class="content">
<div class="post"><h2>Proximity Sensing with the VCNL4000 + Arduino</h2>
<div class="postContent">
<p><img class="noFrame" src="images/2012/01/VCNL4000.jpg"/></p>
<div class="columnBody">
<div class="leftColumn">
I'm not really sure why, but proximity sensors are some of my favorite things in the sensor world. Maybe because there are so many of them? Who knows. Whatever the reason, the VCNL4000 is another proximity sensor that caught my eye, so I picked one up from <a href="http://www.sparkfun.com/">Sparkfun</a> on this handy <a href="http://www.sparkfun.com/products/10901">breakout board</a>.
<p>The VCNL4000 looks like it is a single piece of silicon, but it really just is an infrared transmitter and receiver in a package that looks like a chip. Unfortunately, but much like <a href="./various-proximity-sensors-arduino">many other proximity sensors</a> the VCNL4000 can not easily be used for measuring exact distance. The way it works is that it shines a beam of IR light from an LED, and measures the intensity of light that is bounced pack. But that reading is not linear, so you can't say 5cm is X so 10cm is 2X, it may only be 1.2X. Also note that because it is looking at reflected light, the surface of the object the light is reflecting off of will have an impact on the reading. So a reflective surface will read as a higher value than a dark matte surface even at the same distance. </p>
<p>But what makes this part special is that it also incorporates a pretty sensitive ambient light sensor. Also, unlike many other proximity sensors, the VCNL4000 does not have a simple analog output, but instead outputs a 16bit digital reading. So it is much more sensitive (32x) than what the Arduino's native analog pins could do.</p>
<h3>Proximity Sensing</h3>
<p>The VCNL4000 data sheet claims a proximity sensing range of 20cm. In reality, I was only seeing a reasonable change inside 10cm, with major change happening within 8cm. Also, 16bits over 20cm is probably hugely overkill, and I doubt you will be able to tell a sub-milimenter difference as the numbers would have you believe. At least not until you get about 3cm away as the sensitivity seems to be exponential. But if you need that kind of result, you probably should get yourself a laser.</p>
</div>
<div class="rightColumn">
<p><a href="images/2012/02/VCNL4000_arduino_hookup2.png"><img alt="" class="alignleft size-medium wp-image-2003" height="637" src="images/2012/02/VCNL4000_arduino_hookup2-400x637.png" title="VCNL4000_arduino_hookup2" width="400"/></a>
</p></div>
</div>
<h3>Ambient Light Sensing</h3>
<p>The ambient light sensor on this thing is really, really good. It's very stable and in lower light it was able to pickup very small changes in light. Shadows that I could barely notice myself triggered a noticeable change in the reading.</p>
<p>So if you only need short range proximity sensing, save your self a load of cash and just pick up a <a href="./various-proximity-sensors-arduino">QRD1114</a>. However, if you need both short-range proximity sensing, and ambient light sensing, this is a really great chip. </p>
<h3>Hooking it up</h3>
<p>The VCNL4000 is an I2C device. I2C is a 2-wire serial connection, so you just need to connect the SDA (Data) and SCL (Clock) lines to your Arduino for communication. On most arduinos SDA is on analog pin 4, and SCL is on analog pin 5. On an arduino mega, SDA is digital 20, and SCL is digital 21. The Leonardo's have their own special connections.</p>
<p>The board needs 3.3v to run, but it also needs 5V for the IR led that it uses to check the proximity.</p>
<h3>Code</h3>
<p>Because the board operates on I2C, the code is kinda crazy. Please don't ask how it works. I don't know that I even know, and there are some bitwise operators on there to complicate it too. But if you just want it to work, here is the code.</p>
<p><b>Note: that the ambient light readings take about 100ms to execute</b></p>
<div class="codesnip-container">
<div class="codeHead">
<a class="copy" href="#">Copy Code</a>
</div>
<pre class="arduino codesnip" style="font-family:monospace;"><span class="co2">#include &lt;Wire.h&gt;</span>

<span class="co2">#define VCNL4000_ADDRESS 0x13  //I2C Address of the board</span>

<span class="kw4">void</span> setup<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="kw3">Serial</span>.<span class="me1">begin</span><span class="br0">(</span>9600<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// Serial's used to debug and print data</span>
  Wire.<span class="me1">begin</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// initialize I2C stuff</span>
  initVCNL4000<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//initilize and setup the board</span>
<span class="br0">}</span>

<span class="kw4">void</span> loop<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="kw4">unsigned</span> <span class="kw4">int</span> ambientValue <span class="sy0">=</span> readAmbient<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//can a tiny bit slow</span>
  <span class="kw4">unsigned</span> <span class="kw4">int</span> proximityValue <span class="sy0">=</span> readProximity<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">Serial</span>.<span class="me1">print</span><span class="br0">(</span>ambientValue<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw3">Serial</span>.<span class="me1">print</span><span class="br0">(</span><span class="st0">" | "</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span>proximityValue<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">delay</span><span class="br0">(</span>100<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">//Just here to slow down the printing</span>
  <span class="co1">//note that the readings take about 100ms to execute</span>
<span class="br0">}</span>






<span class="kw4">void</span> initVCNL4000<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="kw4">byte</span> temp <span class="sy0">=</span> readVCNLByte<span class="br0">(</span>0x81<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw1">if</span> <span class="br0">(</span>temp <span class="sy0">!=</span> <span class="nu12">0x11</span><span class="br0">)</span><span class="br0">{</span>  <span class="co1">// Product ID Should be 0x11</span>
    <span class="kw3">Serial</span>.<span class="me1">print</span><span class="br0">(</span><span class="st0">"initVCNL4000 failed to initialize"</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span>temp<span class="sy0">,</span> HEX<span class="br0">)</span><span class="sy0">;</span>
  <span class="br0">}</span><span class="kw1">else</span><span class="br0">{</span>
    <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span><span class="st0">"VNCL4000 Online..."</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="br0">}</span> 

  <span class="coMULTI">/*VNCL400 init params
   Feel free to play with any of these values, but check the datasheet first!*/</span>
  writeVCNLByte<span class="br0">(</span>0x84<span class="sy0">,</span> 0x0F<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// Configures ambient light measures - Single conversion mode, 128 averages</span>
  writeVCNLByte<span class="br0">(</span>0x83<span class="sy0">,</span> 15<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// sets IR current in steps of 10mA 0-200mA --&gt; 200mA</span>
  writeVCNLByte<span class="br0">(</span>0x89<span class="sy0">,</span> 2<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// Proximity IR test signal freq, 0-3 - 781.25 kHz</span>
  writeVCNLByte<span class="br0">(</span>0x8A<span class="sy0">,</span> 0x81<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// proximity modulator timing - 129, recommended by Vishay </span>
<span class="br0">}</span>


<span class="kw4">unsigned</span> <span class="kw4">int</span> readProximity<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="co1">// readProximity() returns a 16-bit value from the VCNL4000's proximity data registers</span>
  <span class="kw4">byte</span> temp <span class="sy0">=</span> readVCNLByte<span class="br0">(</span>0x80<span class="br0">)</span><span class="sy0">;</span>
  writeVCNLByte<span class="br0">(</span>0x80<span class="sy0">,</span> temp <span class="sy0">|</span> 0x08<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// command the sensor to perform a proximity measure</span>

  <span class="kw1">while</span><span class="br0">(</span><span class="sy0">!</span><span class="br0">(</span>readVCNLByte<span class="br0">(</span>0x80<span class="br0">)</span><span class="sy0">&amp;</span>0x20<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// Wait for the proximity data ready bit to be set</span>
  <span class="kw4">unsigned</span> <span class="kw4">int</span> data <span class="sy0">=</span> readVCNLByte<span class="br0">(</span>0x87<span class="br0">)</span> <span class="sy0">&lt;&lt;</span> <span class="nu0">8</span><span class="sy0">;</span>
  data <span class="sy0">|=</span> readVCNLByte<span class="br0">(</span>0x88<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw1">return</span> data<span class="sy0">;</span>
<span class="br0">}</span>


<span class="kw4">unsigned</span> <span class="kw4">int</span> readAmbient<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="co1">// readAmbient() returns a 16-bit value from the VCNL4000's ambient light data registers</span>
  <span class="kw4">byte</span> temp <span class="sy0">=</span> readVCNLByte<span class="br0">(</span>0x80<span class="br0">)</span><span class="sy0">;</span>
  writeVCNLByte<span class="br0">(</span>0x80<span class="sy0">,</span> temp <span class="sy0">|</span> 0x10<span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// command the sensor to perform ambient measure</span>

  <span class="kw1">while</span><span class="br0">(</span><span class="sy0">!</span><span class="br0">(</span>readVCNLByte<span class="br0">(</span>0x80<span class="br0">)</span><span class="sy0">&amp;</span>0x40<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>  <span class="co1">// wait for the proximity data ready bit to be set</span>
  <span class="kw4">unsigned</span> <span class="kw4">int</span> data <span class="sy0">=</span> readVCNLByte<span class="br0">(</span>0x85<span class="br0">)</span> <span class="sy0">&lt;&lt;</span> <span class="nu0">8</span><span class="sy0">;</span>
  data <span class="sy0">|=</span> readVCNLByte<span class="br0">(</span>0x86<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw1">return</span> data<span class="sy0">;</span>
<span class="br0">}</span>


<span class="kw4">void</span> writeVCNLByte<span class="br0">(</span><span class="kw4">byte</span> address<span class="sy0">,</span> <span class="kw4">byte</span> data<span class="br0">)</span><span class="br0">{</span>
  <span class="co1">// writeVCNLByte(address, data) writes a single byte of data to address</span>
  Wire.<span class="me1">beginTransmission</span><span class="br0">(</span>VCNL4000_ADDRESS<span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">write</span><span class="br0">(</span>address<span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">write</span><span class="br0">(</span>data<span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">endTransmission</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span>


<span class="kw4">byte</span> readVCNLByte<span class="br0">(</span><span class="kw4">byte</span> address<span class="br0">)</span><span class="br0">{</span>
  <span class="co1">// readByte(address) reads a single byte of data from address</span>
  Wire.<span class="me1">beginTransmission</span><span class="br0">(</span>VCNL4000_ADDRESS<span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">write</span><span class="br0">(</span>address<span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">endTransmission</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
  Wire.<span class="me1">requestFrom</span><span class="br0">(</span>VCNL4000_ADDRESS<span class="sy0">,</span> 1<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw1">while</span><span class="br0">(</span><span class="sy0">!</span>Wire.<span class="me1">available</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="kw4">byte</span> data <span class="sy0">=</span> Wire.<span class="me1">read</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>

  <span class="kw1">return</span> data<span class="sy0">;</span>
<span class="br0">}</span></pre>
<div class="codeFoot">
				Unless otherwise stated, this code is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> - Please use, change and share it.
			</div>
</div>
</div>
<div id="attribution">
<p>Article taken from <a href="http://bildr.org/vcnl4000-arduino">bildr.org</a> with minor changes - <i>I am the original author of this content</i></p>
<div id="attributionIcons">
<div class="ccIcon cc"></div>
<div class="ccIcon sa"></div>
<div class="ccIcon attribution"></div>
<div id="attributionText">
<a href="https://creativecommons.org/licenses/by-sa/3.0/">Content available under:<br/>Attribution-Share Alike 3.0 Unported</a>
</div>
</div>
</div>
</div></div></div></body></html>
<!DOCTYPE html >

<html lang="en">
<head>
<meta charset="utf-8"/>
<link href="style/main.css" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/mootools/1.4.0/mootools-yui-compressed.js" type="text/javascript"></script>
<script type="text/javascript">
	
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	
	ga('create', 'UA-4050921-11', 'auto');
	ga('send', 'pageview');
	
	function nospam(user,domain) { window.location = "mailto:" + user + "@" + domain; }
		
		
	window.addEvent('domready', function(){

		$$('.codeHead .copy').addEvent('click', function(event) {
			this.highlight();
			event.stop();
			
			var code = this.getParent('.codesnip-container').getElement('.codesnip');
			
			if (code.select) {
				code.select();
			}else if (document.selection) {
				var range = document.body.createTextRange();
				range.moveToElementText(code);
				range.select();
			} else if (window.getSelection) {
				var range = document.createRange();
				range.selectNode(code);
				window.getSelection().addRange(range);
			}
			
			
			try {
				var successful = document.execCommand('copy');
				var msg = successful ? 'successful' : 'unsuccessful';
				console.log('Copying text command was ' + msg);
			} catch (err) {
				console.log('Oops, unable to copy');
			}
		});
	
	});
	</script>
<!--
	
	Icon Set:	IcoMoon - Free -- http://keyamoon.com/icomoon/
	License:	CC BY-SA 3.0 -- http://creativecommons.org/licenses/by-sa/3.0/
	
	
	Icon Set:	Broccolidry -- http://dribbble.com/shots/587469-Free-16px-Broccolidryiconsaniconsetitisfullof-icons
	License:	Aribitrary -- http://licence.visualidiot.com/
	
	-->
<title>Adam meyer | Arduino</title>
</head>
<body>
<div id="headerWrapper">
<div id="header">
<h1><a href="http://adam-meyer.com">Adam meyer</a></h1>
<h2>Design + Code</h2>
<div id="topNav">
<a href="../about.html" id="aboutLink">About</a>
<a href="../resume.pdf">Resume</a>
<a href="../index.html">Portfolio</a>
<a href="index.html">Arduino Articles</a>
<span id="contactLink"><span onclick="javascript:nospam('sternmeyer','gmail.com');">Contact</span>
<div id="contactLinks">
<a class="icon-twitter" href="http://twitter.com/sternmeyer" title="twitter"></a>
<a class="icon-linkedin" href="http://www.linkedin.com/pub/adam-meyer/20/7a/850/" title="linked in"></a>
<a class="icon-dribbble" href="http://dribbble.com/ameyer" title="dribbble"></a>
<a class="icon-github" href="https://github.com/ameyer" title="github"></a>
<a class="icon-instagram" href="http://instagram.com/sternmeyer" title="instagram"></a>
<a class="icon-envelope2" href="mailto:sternmeyer@gmail.com" title="email"></a>
</div>
</span>
</div>
</div>
</div>
<div id="articleWrapper">
<div class="content">
<div class="post"><h2>Rotary Encoder + Arduino</h2>
<div class="postContent">
<p><img class="noFrame" src="images/2012/03/rotary_encoder.jpg"/></p>
<div class="columnBody">
<div class="leftColumn">
<p>One of the first things anyone does when they start working with the Arduino is to connect it to a potentiometer and control the brightness of and LED or move a servo. Well, a rotary encoder may look like a potentiometer, but other than also having a knob, it is basically the complete opposite.</p>
<p>A rotary encoder is a device that you can rotate infinitely. Simple ones <a href="https://www.sparkfun.com/products/9117">like this one</a> I got from <a href="https://www.sparkfun.com/">sparkfun</a> have no real state like a pot does, so when you start up, you won't be able to simply read from the encoder where it is turned to. But because you can keep turning it it has no beginning, middle or end anyways. However, if you keep track of that rotation in code, you can use it as a knob input you can turn up or down as much as you would like.</p>
<p>On most rotary encoders, when you rotate them, you will feel a bump. These are known as steps, and most rotary encoders like this guy have about 12 of these per rotation. But some have 200 or more. Basically this step is the minimum amount you can rotate the encoder to register any change. </p>
<p>Most simple encoders like this only make use of 3 pins, and one of those is ground. Those other two pins change state and are always either high or low, so they can only have a total of 4 combinations. 00, 01, 10, and 11. This is known as 2 bit gray code. So when you turn it, the arduino can say... Well you were at 01, and now you are at 00 so you move this way. Or you were at 01, but now you are at 10 so you must have moved the other way. You can see that this encoder has 5 pins, the other 2 are just a simple switch that is engaged when you press down. (see the second illustration on the right)</p>
<p>It sounds super simple, and it kinda is, but what we can do is every time a value changes we can check what direction it moved. Then if we increment a value every time it turned one way, and deincrement it when we move one step the other, we can keep track of how much it has moved since we started. So if you want a knob that can turn up to 11, this is your guy. (there is a double pun in there I promise)</p>
<p>So, the really funky thing about a rotary encoder is for it to work, we need to know every time those values change. This can be hard because if the arduino is in the middle of doing something, like delay(1000) or what have you, we will miss the change. So we need a way to say to the arduino "I don't care what you are doing, or when you are doing it, if you see any of these two pins change state, you drop everything and attend to them". To do this we need something called interrupts.</p>
</div>
<div class="rightColumn">
<a href="images/2012/03/Rotary_Encoder_Arduino_Hookup.png"><img alt="" class="alignleft size-medium wp-image-2055" height="335" src="images/2012/03/Rotary_Encoder_Arduino_Hookup-400x335.png" title="Rotary_Encoder_Arduino_Hookup" width="400"/></a>
<p class="caption">Hookup for just the encoder without the integrated pushbutton</p>
<p><a href="images/2012/03/Rotary_Encoder_Switch_Arduino_Hookup.png"><img alt="" class="alignleft size-medium wp-image-2054" height="335" src="images/2012/03/Rotary_Encoder_Switch_Arduino_Hookup-400x335.png" title="Rotary_Encoder_Switch_Arduino_Hookup" width="400"/></a></p>
<p class="caption">Hookup for encoder and the integrated pushbutton</p>
</div>
</div>
<div class="wideBody">
<h3>Interrupts Are Magic</h3>
<p>Interrupt pins are special pins that can stop your arduino and force it to do something else before it moves on. Because they are special pins you only get a <a href="http://arduino.cc/it/Reference/AttachInterrupt">few of them on your arduino</a>, but these pins can watch for any CHANGE (high to low / low to high), FALLING (high to low) or RISING (low to high). You can attach interrupt functions to these pins, so if a change happens, it will drop everything and run that function. It gets funky as it breaks the basic linear nature of the arduino loop, but can become the most powerful thing when you get the hang of it.</p>
<p>Any global variables that are used inside these functions have a special name. They are called volatile variables, and for good reason. Their values can change at any time. So if you use a volatile twice in your loop, it may not be the same value the second time if it was change during an interrupt function.</p>
<h3>Code</h3>
<p>To keep track of the rotary encoder we are going to do something that will look really weird, so bear with me. The encoder has 2 digital pins that are either HIGH (1) or LOW (0) right? If we treat the pins as binary, we read them as 00, 01, 10, or 11. The sequence the encoder outputs while spinning clockwise is 00, 01, 11, 10 repeat. So if you have a reading of 01, the next reading can either be 00 or 11 depending on the direction the knob is turned. So by adding the previous encoded value to the beginning of the current encoded value we get 1 of 8 possible numbers (0001, 0010, 0100, 0111, 1000, 1011, 1110 &amp; 1101) 1101, 0100, 0010 &amp; 1011 all mean cockwise movement. 1110, 0111, 0001 &amp; 1000 are all counter-clockwise.</p>
<p>So now we can say this: (sum is last reading + current reading)</p>
<pre style="margin: 0 0 20px 0; padding: 0;">
if(sum == 0b1101 || sum == 0b0100 || sum == 0b0010 || sum == 0b1011) encoderValue ++; //clockwise movement
if(sum == 0b1110 || sum == 0b0111 || sum == 0b0001 || sum == 0b1000) encoderValue --; //counter-clockwise movement
</pre>
<p>If we wanted to treat the binary as decimal numbers we could even shorten that to this:</p>
<pre style="margin: 0 0 20px 0; padding: 0;">
if(sum == 13 || sum == 4 || sum == 2 || sum == 11) encoderValue ++;
if(sum == 14 || sum == 7 || sum == 1 || sum == 8 ) encoderValue --;
</pre>
</div>
<div class="wideBody">
<h3>Without pushbutton code</h3>
<div class="codesnip-container">
<div class="codeHead">
<a class="copy" href="#">Copy Code</a>
</div>
<pre class="arduino codesnip" style="font-family:monospace;"><span class="co1">//From bildr article: http://bildr.org/2012/08/rotary-encoder-arduino/</span>

<span class="co1">//these pins can not be changed 2/3 are special pins</span>
<span class="kw4">int</span> encoderPin1 <span class="sy0">=</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">int</span> encoderPin2 <span class="sy0">=</span> <span class="nu0">3</span><span class="sy0">;</span>

<span class="kw4">volatile</span> <span class="kw4">int</span> lastEncoded <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="kw4">volatile</span> <span class="kw4">long</span> encoderValue <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">long</span> lastencoderValue <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">int</span> lastMSB <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="kw4">int</span> lastLSB <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">void</span> setup<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="kw3">Serial</span>.<span class="me1">begin</span> <span class="br0">(</span>9600<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">pinMode</span><span class="br0">(</span>encoderPin1<span class="sy0">,</span> <span class="kw2">INPUT</span><span class="br0">)</span><span class="sy0">;</span> 
  <span class="kw3">pinMode</span><span class="br0">(</span>encoderPin2<span class="sy0">,</span> <span class="kw2">INPUT</span><span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">digitalWrite</span><span class="br0">(</span>encoderPin1<span class="sy0">,</span> <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//turn pullup resistor on</span>
  <span class="kw3">digitalWrite</span><span class="br0">(</span>encoderPin2<span class="sy0">,</span> <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//turn pullup resistor on</span>

  <span class="co1">//call updateEncoder() when any high/low changed seen</span>
  <span class="co1">//on interrupt 0 (pin 2), or interrupt 1 (pin 3) </span>
  <span class="kw3">attachInterrupt</span><span class="br0">(</span>0<span class="sy0">,</span> updateEncoder<span class="sy0">,</span> CHANGE<span class="br0">)</span><span class="sy0">;</span> 
  <span class="kw3">attachInterrupt</span><span class="br0">(</span>1<span class="sy0">,</span> updateEncoder<span class="sy0">,</span> CHANGE<span class="br0">)</span><span class="sy0">;</span>

<span class="br0">}</span>

<span class="kw4">void</span> loop<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span> 
  <span class="co1">//Do stuff here</span>

  <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span>encoderValue<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw3">delay</span><span class="br0">(</span>1000<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//just here to slow down the output, and show it will work  even during a delay</span>
<span class="br0">}</span>


<span class="kw4">void</span> updateEncoder<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="kw4">int</span> MSB <span class="sy0">=</span> <span class="kw3">digitalRead</span><span class="br0">(</span>encoderPin1<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//MSB = most significant bit</span>
  <span class="kw4">int</span> LSB <span class="sy0">=</span> <span class="kw3">digitalRead</span><span class="br0">(</span>encoderPin2<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//LSB = least significant bit</span>

  <span class="kw4">int</span> encoded <span class="sy0">=</span> <span class="br0">(</span>MSB <span class="sy0">&lt;&lt;</span> 1<span class="br0">)</span> <span class="sy0">|</span>LSB<span class="sy0">;</span> <span class="co1">//converting the 2 pin value to single number</span>
  <span class="kw4">int</span> sum  <span class="sy0">=</span> <span class="br0">(</span>lastEncoded <span class="sy0">&lt;&lt;</span> 2<span class="br0">)</span> <span class="sy0">|</span> encoded<span class="sy0">;</span> <span class="co1">//adding it to the previous encoded value</span>

  <span class="kw1">if</span><span class="br0">(</span>sum <span class="sy0">==</span> 0b1101 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0100 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0010 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b1011<span class="br0">)</span> encoderValue <span class="sy0">++;</span>
  <span class="kw1">if</span><span class="br0">(</span>sum <span class="sy0">==</span> 0b1110 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0111 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0001 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b1000<span class="br0">)</span> encoderValue <span class="sy0">--;</span>

  lastEncoded <span class="sy0">=</span> encoded<span class="sy0">;</span> <span class="co1">//store this value for next time</span>
<span class="br0">}</span></pre>
<div class="codeFoot">
				Unless otherwise stated, this code is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> - Please use, change and share it.
			</div>
</div>
<h3>With pushbutton code</h3>
<div class="codesnip-container">
<div class="codeHead">
<a class="copy" href="#">Copy Code</a>
</div>
<pre class="arduino codesnip" style="font-family:monospace;"><span class="co1">//From bildr article: http://bildr.org/2012/08/rotary-encoder-arduino/</span>

<span class="co1">//these pins can not be changed 2/3 are special pins</span>
<span class="kw4">int</span> encoderPin1 <span class="sy0">=</span> <span class="nu0">2</span><span class="sy0">;</span>
<span class="kw4">int</span> encoderPin2 <span class="sy0">=</span> <span class="nu0">3</span><span class="sy0">;</span>
<span class="kw4">int</span> encoderSwitchPin <span class="sy0">=</span> <span class="nu0">4</span><span class="sy0">;</span> <span class="co1">//push button switch</span>

<span class="kw4">volatile</span> <span class="kw4">int</span> lastEncoded <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="kw4">volatile</span> <span class="kw4">long</span> encoderValue <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">long</span> lastencoderValue <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">int</span> lastMSB <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="kw4">int</span> lastLSB <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>

<span class="kw4">void</span> setup<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="kw3">Serial</span>.<span class="me1">begin</span> <span class="br0">(</span>9600<span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">pinMode</span><span class="br0">(</span>encoderPin1<span class="sy0">,</span> <span class="kw2">INPUT</span><span class="br0">)</span><span class="sy0">;</span> 
  <span class="kw3">pinMode</span><span class="br0">(</span>encoderPin2<span class="sy0">,</span> <span class="kw2">INPUT</span><span class="br0">)</span><span class="sy0">;</span>

  <span class="kw3">pinMode</span><span class="br0">(</span>encoderSwitchPin<span class="sy0">,</span> <span class="kw2">INPUT</span><span class="br0">)</span><span class="sy0">;</span>


  <span class="kw3">digitalWrite</span><span class="br0">(</span>encoderPin1<span class="sy0">,</span> <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//turn pullup resistor on</span>
  <span class="kw3">digitalWrite</span><span class="br0">(</span>encoderPin2<span class="sy0">,</span> <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//turn pullup resistor on</span>

  <span class="kw3">digitalWrite</span><span class="br0">(</span>encoderSwitchPin<span class="sy0">,</span> <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">//turn pullup resistor on</span>


  <span class="co1">//call updateEncoder() when any high/low changed seen</span>
  <span class="co1">//on interrupt 0 (pin 2), or interrupt 1 (pin 3) </span>
  <span class="kw3">attachInterrupt</span><span class="br0">(</span>0<span class="sy0">,</span> updateEncoder<span class="sy0">,</span> CHANGE<span class="br0">)</span><span class="sy0">;</span> 
  <span class="kw3">attachInterrupt</span><span class="br0">(</span>1<span class="sy0">,</span> updateEncoder<span class="sy0">,</span> CHANGE<span class="br0">)</span><span class="sy0">;</span>

<span class="br0">}</span>

<span class="kw4">void</span> loop<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span> 
  <span class="co1">//Do stuff here</span>
  <span class="kw1">if</span><span class="br0">(</span><span class="kw3">digitalRead</span><span class="br0">(</span>encoderSwitchPin2<span class="br0">)</span><span class="br0">)</span><span class="br0">{</span>
    <span class="co1">//button is not being pushed</span>
  <span class="br0">}</span><span class="kw1">else</span><span class="br0">{</span>
    <span class="co1">//button is being pushed</span>
  <span class="br0">}</span>
Â 
  <span class="kw3">Serial</span>.<span class="me1">println</span><span class="br0">(</span>encoderValue<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw3">delay</span><span class="br0">(</span>1000<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//just here to slow down the output, and show it will work  even during a delay</span>
<span class="br0">}</span>


<span class="kw4">void</span> updateEncoder<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="kw4">int</span> MSB <span class="sy0">=</span> <span class="kw3">digitalRead</span><span class="br0">(</span>encoderPin1<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//MSB = most significant bit</span>
  <span class="kw4">int</span> LSB <span class="sy0">=</span> <span class="kw3">digitalRead</span><span class="br0">(</span>encoderPin2<span class="br0">)</span><span class="sy0">;</span> <span class="co1">//LSB = least significant bit</span>

  <span class="kw4">int</span> encoded <span class="sy0">=</span> <span class="br0">(</span>MSB <span class="sy0">&lt;&lt;</span> 1<span class="br0">)</span> <span class="sy0">|</span>LSB<span class="sy0">;</span> <span class="co1">//converting the 2 pin value to single number</span>
  <span class="kw4">int</span> sum  <span class="sy0">=</span> <span class="br0">(</span>lastEncoded <span class="sy0">&lt;&lt;</span> 2<span class="br0">)</span> <span class="sy0">|</span> encoded<span class="sy0">;</span> <span class="co1">//adding it to the previous encoded value</span>

  <span class="kw1">if</span><span class="br0">(</span>sum <span class="sy0">==</span> 0b1101 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0100 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0010 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b1011<span class="br0">)</span> encoderValue <span class="sy0">++;</span>
  <span class="kw1">if</span><span class="br0">(</span>sum <span class="sy0">==</span> 0b1110 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0111 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b0001 <span class="sy0">||</span> sum <span class="sy0">==</span> 0b1000<span class="br0">)</span> encoderValue <span class="sy0">--;</span>

  lastEncoded <span class="sy0">=</span> encoded<span class="sy0">;</span> <span class="co1">//store this value for next time</span>
<span class="br0">}</span></pre>
<div class="codeFoot">
				Unless otherwise stated, this code is released under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> - Please use, change and share it.
			</div>
</div>
</div>
</div>
<div id="attribution">
<p>Article taken from <a href="http://bildr.org/rotary-encoder-arduino">bildr.org</a> with minor changes - <i>I am the original author of this content</i></p>
<div id="attributionIcons">
<div class="ccIcon cc"></div>
<div class="ccIcon sa"></div>
<div class="ccIcon attribution"></div>
<div id="attributionText">
<a href="https://creativecommons.org/licenses/by-sa/3.0/">Content available under:<br/>Attribution-Share Alike 3.0 Unported</a>
</div>
</div>
</div>
</div></div></div></body></html>